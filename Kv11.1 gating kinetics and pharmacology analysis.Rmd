---
title: "K~v~11.1 gating kinetics and pharmacology analysis"
author: "Lennert Heirman"
date: "`r Sys.Date()`"
output: 
  html_document: 
    number_sections: true
    theme: paper
editor_options: 
  chunk_output_type: console
---
# Introduction 

This is an R Markdown document for the analysis of patch clamp experiments of K~v~11.1/ERG channel, which is responsible for the IKr current. First, a comparison of gating kinetics will be made using a human and equine clone of KCNH2. After this, current inhibition by different drugs or channel blockers will be investigated.

A good paper with experimental protocols and notes on the analysis is the review of hERG by Vandenberg et al. (doi.org/10.1152/physrev.00036.2011). I will also use this paper to help me for analysis of gating kinetics of my clones. The clone used for human K~v~11.1 is the same as the one used in Saenen et al. (doi.org/10.1529/biophysj.106.087247) for wild-type hERG. I will also use this paper to guide me in the analysis of gating kinetics.

# Set working directory
```{r}
setwd("C:/R_Projects/Kv11.1 analysis")
```

# Gating kinetics of K~v~11.1

## Steady state activation

The voltage-dependence of K~v~11.1 activation is assessed using tail current analysis. From a holding potential of -90 mV, channels are activated with a series of depolarizing P1 pulses (typically from -80 mV to -60 mV for wild-type K~v~11.1), and tail currents are recorded during a repolarizing P2 pulse (typically -60 mV). Inactivation of Kv11.1 at depolarized potentials means significant rectification is seen during the P1 pulse, while fast recovery from inactivation relative to deactivation ensures that the magnitude of the tail current during P2 is an accurate representation of the proportion of channels activated during the preceding P1 pulse. A fit of the Boltzmann equation to the peak tail current measured during P2 allows an assessment of the V0.5 of activation as well as a slope factor that approximates the activation gating charge.

As a consequence of the slow kinetics of K~v~11.1 activation, it is important to ensure the P1 pulse is of sufficient duration to allow activation to reach as close as possible to steady state. Indeed, the data obtained from a tail pulse protocol should really be referred to as isochronal activation data with specific mention of the duration of the P1 pulse duration.

Activation protocol used:

  - Holding level: -80 mV
  - P1: 2s, depolarizing pulses from -80 mV to 60 mV (15 sweeps)
  - P2: 400 ms, repolarising pulse -40 mV
  - Interpulse interval: 15s
  
Recordings were made at room temperature
Lowpass filtered and sampled at 1-10 kHz

To determine voltage dependence of activation, normalized peak tail currents will be fitted against a Boltzmann equation: y = 1/(1 + exp((V05 - V)/ k)) with:

  - V: the applied voltage 
  - V05: the voltage at which 50% of the channels are activated
  - k: the slope factor. 1/k corresponds to zF/RT in which z is the equivalent charge and F, R, and T have their usual meanings

(This is what they call in clampex the 'Charge-Voltage Boltzmann, if you do this on  quick IV, it replaces 1 with Imax so essentially this is the same as doing this on a Inorm with 1')

Normalized peak current is obtained by making a mean of the peak tail current during the repolarising P2 pulse for each previous Epoch level (which is the voltage of the depolarising P1 pulse) using Clampex software. For each cell and recording, the peak tail current (in pA) and corresponding membrane voltage (in mV) during the preceding depolarising pulse is put in a long format excel. This peak tail current is than normalized to the maximal peak tail current of that recording. Membrane capacitance (in pF) and access resistance (in MOhms) is also in this long format excel for each cell.

For each membrane voltage level, a mean ± SEM of I~norm~ for all analysed cells is made, these values are then plotted and fitted with the abovementioned Boltzmann curve. 

### P1 duration 2000 ms
```{r}
# Read in data as a long format excel
library(readxl)
Tailcurrent_Equine_Human <- read_excel("Kv11.1_CHO_Equine_Human_Peak tail current_long format.xlsx")
View(Tailcurrent_Equine_Human)
names(Tailcurrent_Equine_Human)

# Substract baseline
library(dplyr)
df_baseline_substracted <- Tailcurrent_Equine_Human %>%
  group_by(Recording) %>%
  mutate(
    min_tailcurrent = min(Peak_tail_current, na.rm = TRUE),
    baseline_substracted_tailcurrent = Peak_tail_current - min_tailcurrent
  ) %>%
  ungroup()
View(df_baseline_substracted)

# Normalize data to maximal peak tail current
df_norm <- df_baseline_substracted %>%
  group_by(Recording) %>%   # normalize per recording
  mutate(
    max_tailcurrent = max(`baseline_substracted_tailcurrent`, na.rm = TRUE),
    norm_tailcurrent = `baseline_substracted_tailcurrent` / max_tailcurrent
  ) %>%
  ungroup()
View(df_norm)

# Select only recordings with a P1 pulse of 2000 ms
df_2000 <- df_norm %>%
  filter(P1 == 2000)
View(df_2000)

# Make a summary data frame with mean and SEM for each species
library(dplyr)
summary_df_2000 <- df_2000 %>%
  group_by(Species, `Membrane_voltage`) %>%
  summarise(
    mean_Inorm = mean(`norm_tailcurrent`, na.rm = TRUE),
    SEM_Inorm  = sd(`norm_tailcurrent`, na.rm = TRUE) / sqrt(n()),
    n = n(),
    .groups = "drop"
  )
View(summary_df_2000)
str(summary_df_2000)

# Count the amount of cells analysed for each species
n_per_species_2000 <- df_2000 %>%
  group_by(Species, Cell) %>%   # ensure unique recordings
  summarise(.groups = "drop") %>%
  count(Species, name = "n_cells")

n_per_species_2000

# Make a wide summary data frame giving the tailcurrent for equine and human for each Vm
library(tidyr)
summary_wide_2000 <- summary_df_2000 %>%
  select(Species, Membrane_voltage, mean_Inorm, SEM_Inorm) %>%
  pivot_wider(
    names_from  = Species,
    values_from = c(mean_Inorm, SEM_Inorm),
    names_glue  = "{.value}_{Species}"
  ) %>%
  arrange(Membrane_voltage)
View(summary_wide_2000)

# Define Boltzmann function
Boltzmann <- function(V, V05, k) {1/(1 + exp((V05 - V)/ k))}

# Species-specific initial guesses
guess_params <- function(df) {
  V05_g <- df$Membrane_voltage[which.min(abs(df$mean_Inorm - 0.5))]
  k_g   <- (max(df$Membrane_voltage) - min(df$Membrane_voltage)) / 8
  list(V05 = V05_g, k = k_g)}

g_eq_2000 <- guess_params(filter(summary_df_2000, Species == "Equine"))
g_hu_2000 <- guess_params(filter(summary_df_2000, Species == "Human"))


# Non-linear Least Squares Fit
Boltzmann_equine_2000 <- nls(
  mean_Inorm ~ Boltzmann(Membrane_voltage, V05, k),
  data  = filter(summary_df_2000, Species == "Equine"),
  start = list(V05 = g_eq_2000$V05, k = g_eq_2000$k))
summary(Boltzmann_equine_2000)

Boltzmann_human_2000 <- nls(mean_Inorm ~ Boltzmann(Membrane_voltage, V05, k), 
           data = filter(summary_df_2000, Species == "Human"), 
           start = list(V05 = g_hu_2000$V05, k = g_hu_2000$k))
summary(Boltzmann_human_2000)

# Plot the fit
vseq_2000 <- seq(min(summary_df_2000$Membrane_voltage),
            max(summary_df_2000$Membrane_voltage),
            length.out = 1000)

df_pred_equine_2000 <- data.frame(
  Membrane_voltage = vseq_2000,
  fit = predict(Boltzmann_equine_2000, newdata = data.frame(Membrane_voltage = vseq_2000)),
  Species = "Equine")

df_pred_human_2000 <- data.frame(
  Membrane_voltage = vseq_2000,
  fit = predict(Boltzmann_human_2000, newdata = data.frame(Membrane_voltage = vseq_2000)),
  Species = "Human")

df_pred_2000 <- rbind(df_pred_equine_2000, df_pred_human_2000)

library(ggplot2)
my_cols <- c(
  "Equine" = "#23815E",   
  "Human"  = "#660027")

my_shapes <- c(
  "Equine" = 22,  
  "Human"  = 24)

my_fills <- c(
  "Equine" = "#B0D8C9",  
  "Human"  = "#E48FB0")

legend_labels_2000 <- paste0(n_per_species_2000$Species, " (n = ", n_per_species_2000$n_cells, ")")

names(legend_labels_2000) <- n_per_species_2000$Species
legend_labels_2000

ggplot(summary_df_2000, aes(x = Membrane_voltage, y = mean_Inorm, color = Species)) +
  theme_classic() +
  theme(panel.grid.major = element_line(color = "grey85", size = 0.3), panel.grid.minor = element_line(color = "grey92", size = 0.2)) +
  geom_point(aes(shape = Species, color = Species, fill = Species),size = 4) +
  geom_errorbar(aes(ymin = mean_Inorm - SEM_Inorm,ymax = mean_Inorm + SEM_Inorm),width = 2, linewidth = 0.6) +
  geom_line(data = df_pred_2000,aes(y = fit),linewidth = 0.8) +
  scale_color_manual(values = my_cols, labels = legend_labels_2000) +
  scale_shape_manual(values = my_shapes, labels = legend_labels_2000) +
  scale_fill_manual(values = my_fills, labels = legend_labels_2000) +
  labs(x = "Membrane voltage (mV)", y = "Inorm (mean ± SEM)",title = "P1 duration 2000 ms") +
  scale_x_continuous(breaks = seq(-80, 60, 20), minor_breaks = seq(-80, 60, 5),   limits = c(-82, 62), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0, 1.0, 0.2), minor_breaks = seq(0, 1, 0.05),    limits = c(-0.02, 1.02), expand = c(0, 0)) +
  coord_cartesian(clip = "off")

ggsave("IV_curve_Kv11.1_Equine_Human_P1_2000.png", width = 10, height = 5, dpi = 600)

# Create a table with Vhalf and slope
coef_equine_2000 <- summary(Boltzmann_equine_2000)$coefficients
coef_human_2000  <- summary(Boltzmann_human_2000)$coefficients

Boltzmann_table_2000 <- data.frame(
  Species = c("Equine", "Human"),
  V05 = c(coef_equine_2000["V05","Estimate"], coef_human_2000["V05","Estimate"]),
  V05_SEM = c(coef_equine_2000["V05","Std. Error"], coef_human_2000["V05","Std. Error"]),
  k = c(coef_equine_2000["k","Estimate"], coef_human_2000["k","Estimate"]),
  k_SEM = c(coef_equine_2000["k","Std. Error"], coef_human_2000["k","Std. Error"]))

Boltzmann_table_2000
```

### P1 duration 4000 ms
```{r}
# Read in data as a long format excel
library(readxl)
Tailcurrent_Equine_Human <- read_excel("Kv11.1_CHO_Equine_Human_Peak tail current_long format.xlsx")
View(Tailcurrent_Equine_Human)
names(Tailcurrent_Equine_Human)

# Substract baseline
library(dplyr)
df_baseline_substracted <- Tailcurrent_Equine_Human %>%
  group_by(Recording) %>%
  mutate(
    min_tailcurrent = min(Peak_tail_current, na.rm = TRUE),
    baseline_substracted_tailcurrent = Peak_tail_current - min_tailcurrent
  ) %>%
  ungroup()
View(df_baseline_substracted)

# Normalize data to maximal peak tail current
df_norm <- df_baseline_substracted %>%
  group_by(Recording) %>%   # normalize per recording
  mutate(
    max_tailcurrent = max(`baseline_substracted_tailcurrent`, na.rm = TRUE),
    norm_tailcurrent = `baseline_substracted_tailcurrent` / max_tailcurrent
  ) %>%
  ungroup()
View(df_norm)

# Select only recordings with a P1 pulse of 4000 ms
df_4000 <- df_norm %>%
  filter(P1 == 4000)
View(df_4000)

# Make a summary data frame with mean and SEM for each species
library(dplyr)
summary_df_4000<- df_4000 %>%
  group_by(Species, `Membrane_voltage`) %>%
  summarise(
    mean_Inorm = mean(`norm_tailcurrent`, na.rm = TRUE),
    SEM_Inorm  = sd(`norm_tailcurrent`, na.rm = TRUE) / sqrt(n()),
    n = n(),
    .groups = "drop"
  )
View(summary_df_4000)
str(summary_df_4000)

# Count the amount of cells analysed for each species
n_per_species_4000 <- df_4000 %>%
  group_by(Species, Cell) %>%   # ensure unique recordings
  summarise(.groups = "drop") %>%
  count(Species, name = "n_cells")

n_per_species_4000

# Make a wide summary data frame giving the tailcurrent for equine and human for each Vm
library(tidyr)
summary_wide_4000 <- summary_df_4000 %>%
  select(Species, Membrane_voltage, mean_Inorm, SEM_Inorm) %>%
  pivot_wider(
    names_from  = Species,
    values_from = c(mean_Inorm, SEM_Inorm),
    names_glue  = "{.value}_{Species}"
  ) %>%
  arrange(Membrane_voltage)
View(summary_wide_4000)

# Define Boltzmann function
Boltzmann <- function(V, V05, k) {1/(1 + exp((V05 - V)/ k))}

# Species-specific initial guesses
guess_params <- function(df) {
  V05_g <- df$Membrane_voltage[which.min(abs(df$mean_Inorm - 0.5))]
  k_g   <- (max(df$Membrane_voltage) - min(df$Membrane_voltage)) / 8
  list(V05 = V05_g, k = k_g)}

g_eq_4000 <- guess_params(filter(summary_df_4000, Species == "Equine"))
g_hu_4000 <- guess_params(filter(summary_df_4000, Species == "Human"))


# Non-linear Least Squares Fit
Boltzmann_equine_4000 <- nls(
  mean_Inorm ~ Boltzmann(Membrane_voltage, V05, k),
  data  = filter(summary_df_4000, Species == "Equine"),
  start = list(V05 = g_eq_4000$V05, k = g_eq_4000$k))
summary(Boltzmann_equine_4000)

Boltzmann_human_4000 <- nls(mean_Inorm ~ Boltzmann(Membrane_voltage, V05, k), 
           data = filter(summary_df_4000, Species == "Human"), 
           start = list(V05 = g_hu_4000$V05, k = g_hu_4000$k))
summary(Boltzmann_human_4000)

# Plot the fit
vseq_4000 <- seq(min(summary_df_4000$Membrane_voltage),
            max(summary_df_4000$Membrane_voltage),
            length.out = 1000)

df_pred_equine_4000 <- data.frame(
  Membrane_voltage = vseq_4000,
  fit = predict(Boltzmann_equine_4000, newdata = data.frame(Membrane_voltage = vseq_4000)),
  Species = "Equine")

df_pred_human_4000 <- data.frame(
  Membrane_voltage = vseq_4000,
  fit = predict(Boltzmann_human_4000, newdata = data.frame(Membrane_voltage = vseq_4000)),
  Species = "Human")

df_pred_4000 <- rbind(df_pred_equine_4000, df_pred_human_4000)

library(ggplot2)
my_cols <- c(
  "Equine" = "#23815E",   
  "Human"  = "#660027")

my_shapes <- c(
  "Equine" = 22,  
  "Human"  = 24)

my_fills <- c(
  "Equine" = "#B0D8C9",  
  "Human"  = "#E48FB0")

legend_labels_4000 <- paste0(n_per_species_4000$Species, " (n = ", n_per_species_4000$n_cells, ")")

names(legend_labels_4000) <- n_per_species_4000$Species
legend_labels_4000

ggplot(summary_df_4000, aes(x = Membrane_voltage, y = mean_Inorm, color = Species)) +
  theme_classic() +
  theme(panel.grid.major = element_line(color = "grey85", size = 0.3), panel.grid.minor = element_line(color = "grey92", size = 0.2)) +
  geom_point(aes(shape = Species, color = Species, fill = Species),size = 4) +
  geom_errorbar(aes(ymin = mean_Inorm - SEM_Inorm,ymax = mean_Inorm + SEM_Inorm),width = 2, linewidth = 0.6) +
  geom_line(data = df_pred_4000,aes(y = fit),linewidth = 0.8) +
  scale_color_manual(values = my_cols, labels = legend_labels_4000) +
  scale_shape_manual(values = my_shapes, labels = legend_labels_4000) +
  scale_fill_manual(values = my_fills, labels = legend_labels_4000) +
  labs(x = "Membrane voltage (mV)", y = "Inorm (mean ± SEM)",title = "P1 duration 4000 ms") +
  scale_x_continuous(breaks = seq(-80, 60, 20), minor_breaks = seq(-80, 60, 5),   limits = c(-82, 62), expand = c(0, 0)) +
  scale_y_continuous(breaks = seq(0, 1.0, 0.2), minor_breaks = seq(0, 1, 0.05),    limits = c(-0.02, 1.02), expand = c(0, 0)) +
  coord_cartesian(clip = "off")

ggsave("IV_curve_Kv11.1_Equine_Human_P1_4000.png", width = 10, height = 5, dpi = 600)

# Create a table with Vhalf and slope
coef_equine_4000 <- summary(Boltzmann_equine_4000)$coefficients
coef_human_4000  <- summary(Boltzmann_human_4000)$coefficients

Boltzmann_table_4000 <- data.frame(
  Species = c("Equine", "Human"),
  V05 = c(coef_equine_4000["V05","Estimate"], coef_human_4000["V05","Estimate"]),
  V05_SEM = c(coef_equine_4000["V05","Std. Error"], coef_human_4000["V05","Std. Error"]),
  k = c(coef_equine_4000["k","Estimate"], coef_human_4000["k","Estimate"]),
  k_SEM = c(coef_equine_4000["k","Std. Error"], coef_human_4000["k","Std. Error"]))

Boltzmann_table_4000
```

### Ceate csv file with Boltzmann parameters
```{r}
Boltzmann_combined <- rbind(
  cbind(P1 = 2000, Boltzmann_table_2000),
  cbind(P1 = 4000, Boltzmann_table_4000)
)

write.csv(Boltzmann_combined, "Kv11.1_Equine_Human_Boltzmann_coefficients.csv", row.names = FALSE)
```

## Rates of activation

## Rates of deactivation

## Rates of inactivation


# Current inhibtion by adding drugs or channel blockers

